<title>Arkanoid con Javascript</title>


<style>
    body{
        background: #111;
    }

    canvas{
        border: solid white 4px;
        border-bottom: none;
        background: url('./bkg.png');
        margin: 0 auto;
        display: block;
    }

    button{
        background-color: #111;
        color: white;
        font-size: large;
        font-weight: 600;
        border-radius: 16px;
        padding: 10px;
        margin: 1em;
    }
</style>

<canvas></canvas>
<img hidden id='sprite' src="./sprite.png" alt="Sprite Arkanoid"/>
<img hidden id="bricks" src="./bricks.png" alt="Sprite Bricks Arkanoid"/>


<script>
    const canvas = document.querySelector('canvas')
    const context = canvas.getContext('2d')

    const $sprite =  document.querySelector('#sprite')
    const $bricks =  document.querySelector('#bricks')

    canvas.width = 448
    canvas.height = 400

    // variables del juego
    let counter = 0

    // VARIABLES DE LA PELOTA
    const ballRadius = 4;
    
    let x = canvas.width / 2  // posición de la pelota
    let y = canvas.height -30

    //velocidad de la pelota y dirección
    let dx = 3
    let dy = -3 // si va en negativo la pelota subira

    //VARIABLES DE LA PALETA
    const PADDLE_SENSITIBITY = 8
    const paddleHeight = 10
    const paddleWidth = 50

    let paddleX = (canvas.width - paddleWidth) / 2
    let paddleY = canvas.height - paddleHeight - 10 

    let rightPressed = false
    let leftPressed = false

    // VARIABLES DE LOS BRICKS
    const brickRowCount = 6
    const brickColumnCount = 13
    const brickWidth = 30
    const brickHeight = 14 
    const brickPadding = 2
    const brickOffSetTop = 80
    const brickOffSetLeft = 16
    const bricks = []

    const BRICK_STATUS = {
        ACTIVE : 1,
        DESTROYED: 0
    }

    for ( let column = 0; column < brickColumnCount; column++){
        bricks[column] = [] // inicializamos con el array vacio
        for (let row = 0; row < brickRowCount; row++){
            // calculamos la posición del ladrillo en la pantalla
            const brickX = column * (brickWidth + brickPadding) + brickOffSetLeft
            const brickY = row * (brickHeight + brickPadding) + brickOffSetTop
            // asignar color aleatorio al ladrillo
            const random = Math.floor(Math.random() * 8) // indice aleatorio del 0 al 7
            // guardamos la info de cada ladrillo
            bricks[column][row] = {
                x: brickX,
                y: brickY, 
                status: BRICK_STATUS.ACTIVE, color: random
            }
        }
    }

    function drawBall(){
        context.beginPath() //iniciar el trazado
        context.arc(x,y, ballRadius, 0 , Math.PI * 2)
        context.fillStyle = '#fff'
        context.fill()
        context.closePath() // cierre para mejorar rendimiento, terminar trazado
    }

    function drawPaddle(){
        context.fillStyle = '#09f'
        // context.fillRect( // llenar un rectángulo
        //     paddleX, // la coord X
        //     paddleY, // la coord Y
        //     paddleWidth, // ancho del dibujo
        //     paddleHeight) // alto del dibujo
        
            context.drawImage(
                $sprite,  //imagen
                29,       // clipX donde empieza a recortar
                174,      // clipY coordenadas de recorte
                paddleWidth, // tamaño de recorte
                paddleHeight, // tamaño de recorte
                paddleX,  //posición X del dibujo
                paddleY,  //posición Y del dibujo
                paddleWidth, // ancho del dibujo
                paddleHeight    // alto del dibujo

            )
    }

    function drawBricks(){
        for ( let column = 0; column < brickColumnCount; column++){
            for (let row = 0; row < brickRowCount; row++){
            const currentBrick = bricks[column][row]
            if (currentBrick.status === BRICK_STATUS.DESTROYED) 
            continue;
            
            contex.fillStyle = 'yellow'
            context.rect(
                currentBrick.x,
                currentBrick.y,
                brickWidth,
                brickHeight
            )
            context.fill()
            }
        }
    }
    

    function collisionDetection(){

    }

    function ballMovement(){
        // rebotar las pelotas en los laterales
        if(
            x + dx > canvas.width - ballRadius ||// pared derecha
            x + dx < ballRadius // pared izquierda
        ){
            dx = -dx
        }
        //rebotar en el techo
        if( y + dy < ballRadius /*0 es la posición más alta */){
            dy = -dy
        }
        // colisión con el paddle
        const isBallSamXAsPaddel = ((x > paddleX) && (x < (paddleX + paddleWidth))) // del inicio al final de la pala
        const isBallTouchingPaddle = y + dy > paddleY
       if(isBallSamXAsPaddel && isBallTouchingPaddle){
            dy = -dy
       }else if(y + dy > canvas.height - ballRadius){ //la pelota oca el suelo
            console.log('GAME OVER')
            document.location.reload() // se reinicia
        }
       x +=  dx
       y += dy
    }

    function paddleMovement(){
        if(rightPressed && paddleX < canvas.width - paddleWidth){
            paddleX += PADDLE_SENSITIBITY
        } else if (leftPressed && paddleX > 0){
            paddleX -=  PADDLE_SENSITIBITY
        }
        
    }

    // funcion para limpiar el movimiento anterior de la pantalla
    function cleanCanvas(){
        context.clearRect(0,0, canvas.width, canvas.height)
    }

    function initEvents(){
        document.addEventListener('keydown', keyDownHandler)
        document.addEventListener('keyup', keyUpHandler)

        function keyDownHandler(event){
            const {key}  = event
            if(key === 'Right' || key === 'ArrowRight'){
                rightPressed = true
            } else if(key === 'Left' || key === 'ArrowLeft'){
                leftPressed = true
            }
        }
        function keyUpHandler(event){
            const {key}  = event
            if(key === 'Right' || key === 'ArrowRight'){
                rightPressed = false
            } else if(key === 'Left' || key === 'ArrowLeft'){
                leftPressed = false
            }
        }
    }

    function draw(){
        console.log({leftPressed, rightPressed})
        cleanCanvas() 
        // 1º dibujar los elementos
        drawBall()
        drawPaddle()
        drawBricks()

        //dibujar puntuaciön

        // colisiones y movimientos
        collisionDetection()
        ballMovement()
        paddleMovement()
        
    
        // esta funcion se va a estar llamando constantemente
        window.requestAnimationFrame(draw) 
    }

    draw()
    initEvents()

</script>